<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spotify Genre Sorter (PKCE)</title>
<style>
  :root{--accent:#1DB954}
  body { font-family: Inter, Arial, sans-serif; padding:20px; max-width:1100px; margin:auto; background:#fafafa; color:#111; }
  header { display:flex; gap:12px; align-items:center; margin-bottom:18px;}
  h1 { margin:0; font-size:20px }
  button { background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
  #loginSmall { background:#333; margin-left:auto; }
  #message { margin-top:8px; color:#555; }
  .controls { margin:14px 0; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .stats { font-size:14px; color:#666; }
  .genre-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top:18px; }
  .genre { background:#fff; border-radius:10px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
  .genre h3 { margin:0 0 8px 0; color:var(--accent); font-size:16px; display:flex; justify-content:space-between; align-items:center; gap:8px;}
  .genre ul { margin:0; padding-left:18px; max-height:200px; overflow:auto; font-size:14px; color:#333; }
  .small { font-size:13px; color:#666; }
  .muted { color:#888; font-size:13px; }
  .btn-secondary { background:#eee; color:#111; border-radius:8px; padding:6px 8px; border:0; cursor:pointer; }
  .progress { margin-top:8px; height:8px; background:#eee; border-radius:6px; overflow:hidden; }
  .progress > span { display:block; height:100%; width:0%; background:var(--accent); transition:width 300ms ease; }
</style>
</head>
<body>
<header>
  <h1>Spotify Genre Sorter</h1>
  <button id="login">Login with Spotify</button>
  <button id="logout" style="display:none" class="btn-secondary">Logout</button>
  <div id="loginSmall" style="display:none">Logged in</div>
</header>

<div class="controls">
  <div class="stats" id="stats">Not logged in</div>
  <div id="actions" style="margin-left:auto"></div>
</div>

<div id="message" class="muted"></div>
<div class="progress" style="display:none"><span></span></div>
<div id="genreContainer" class="genre-grid"></div>

<script>
// === CONFIG ===
const clientId = '7639cbefc7464d70ac7d06354024e2d1';
const redirectUri = 'https://tsubaki345.github.io/spotify-genre-sorter/';
const scopes = 'user-library-read playlist-modify-public';

// === UI ELEMENTS ===
const loginBtn = document.getElementById('login');
const logoutBtn = document.getElementById('logout');
const loginSmall = document.getElementById('loginSmall');
const messageEl = document.getElementById('message');
const statsEl = document.getElementById('stats');
const actionsEl = document.getElementById('actions');
const progressWrap = document.querySelector('.progress');
const progressBar = document.querySelector('.progress > span');
const genreContainer = document.getElementById('genreContainer');

let token = null;
let currentUserId = null;

// ===== PKCE HELPERS =====
function generateCodeVerifier(length = 128) {
  const array = new Uint8Array(length);
  crypto.getRandomValues(array);
  return btoa(String.fromCharCode(...array))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// ===== AUTH FLOW =====
async function login() {
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);
  sessionStorage.setItem('pkce_verifier', codeVerifier);

  const url = new URL('https://accounts.spotify.com/authorize');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('response_type', 'code');
  url.searchParams.set('redirect_uri', redirectUri);
  url.searchParams.set('scope', scopes);
  url.searchParams.set('code_challenge_method', 'S256');
  url.searchParams.set('code_challenge', codeChallenge);
  window.location.href = url.toString();
}

async function exchangeCodeForToken(code) {
  const codeVerifier = sessionStorage.getItem('pkce_verifier');
  if (!codeVerifier) throw new Error('PKCE verifier not found in sessionStorage');

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    code_verifier: codeVerifier
  });

  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  });

  if (!res.ok) throw new Error('Failed to exchange code for token: ' + res.status);
  const data = await res.json();
  token = data.access_token;
  sessionStorage.removeItem('pkce_verifier');
  return token;
}

// ===== URL CODE PARSING =====
async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (code) {
    try {
      await exchangeCodeForToken(code);
      history.replaceState(null, '', window.location.pathname); // clean URL
    } catch (err) {
      console.error(err);
      setMessage('Error during login: ' + err.message);
    }
  }
}

// ===== FETCH WRAPPER =====
async function authFetch(url, opts = {}) {
  if (!token) throw new Error('Not authenticated');
  if (!opts.headers) opts.headers = {};
  opts.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(url, opts);
  if (res.status === 401) throw new Error('Unauthorized â€” token may have expired. Please re-login.');
  return res;
}

// ===== UI HELPERS =====
function setMessage(txt) { messageEl.textContent = txt; }
function setStats(txt) { statsEl.textContent = txt; }
function showProgress(enable) { progressWrap.style.display = enable ? 'block' : 'none'; if(!enable) progressBar.style.width='0%'; }
function setProgress(percent) { progressBar.style.width = Math.max(0, Math.min(100, percent)) + '%'; }
function logout() {
  token = null;
  currentUserId = null;
  genreContainer.innerHTML = '';
  loginBtn.style.display = '';
  logoutBtn.style.display = 'none';
  loginSmall.style.display = 'none';
  setMessage('Logged out.');
  setStats('Not logged in');
  actionsEl.innerHTML = '';
}

// ===== MAIN FLOW PLACEHOLDER =====
// You can reuse all your existing track fetching, grouping, and playlist creation functions here.
// The only difference is token handling now comes from PKCE.

loginBtn.onclick = login;
logoutBtn.onclick = logout;

// Run on page load
(async () => {
  await handleRedirect();
  if (token) {
    loginBtn.style.display = 'none';
    logoutBtn.style.display = '';
    loginSmall.style.display = '';
    setMessage('Authenticated. You can now fetch tracks...');
    setStats('Logged in');
    // Call your previous run() function here
    // run();
  }
})();
</script>
</body>
</html>

